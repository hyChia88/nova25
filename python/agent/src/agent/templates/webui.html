<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CheatSheet - Learning Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #ffffff;
            color: #333;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .clippy-icon {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 60px;
            height: auto;
            z-index: 1000;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .clippy-icon:hover {
            transform: scale(1.1);
        }

        .container {
            max-width: 800px;
            width: 100%;
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 3rem;
            color: #222;
        }

        /* File Drop Screen */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .upload-area {
            border: 2px dashed #d0d0d0;
            border-radius: 8px;
            padding: 60px 40px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area.dragover {
            border-color: #666;
            background: #f0f0f0;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #999;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            font-size: 0.9rem;
            color: #999;
        }

        input[type="file"] {
            display: none;
        }

        /* Loading Screen */
        #loadingScreen {
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .loading-step {
            font-size: 1.1rem;
            color: #333;
            margin: 1rem 0;
            min-height: 1.5rem;
            transition: color 0.3s ease;
        }

        .loading-step.completed {
            color: #bbb;
        }

        .loading-step.active {
            color: #333;
            font-weight: 500;
        }

        .loading-dots {
            display: inline-block;
            width: 20px;
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        .concept-preview {
            background: #fafafa;
            border-radius: 8px;
            padding: 20px;
            margin: 2rem auto;
            max-width: 600px;
            text-align: left;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .concept-preview.visible {
            opacity: 1;
        }

        .concept-preview-item {
            margin: 0.75rem 0;
            padding-left: 1rem;
            color: #555;
            font-size: 0.95rem;
        }

        .concept-preview-more {
            text-align: center;
            color: #999;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .start-quiz-btn {
            display: none;
            margin: 2rem auto;
            padding: 12px 30px;
            background: #333;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-quiz-btn.visible {
            display: inline-block;
        }

        .start-quiz-btn:hover {
            background: #555;
        }

        /* Course Selection Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #fff;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
            color: #222;
        }

        .course-list {
            margin-bottom: 1.5rem;
        }

        .course-item {
            padding: 12px 15px;
            margin: 8px 0;
            background: #fafafa;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .course-item:hover {
            background: #f0f0f0;
            border-color: #999;
        }

        .course-item.selected {
            background: #333;
            color: #fff;
            border-color: #333;
        }

        .new-course-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e0e0e0;
        }

        .new-course-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .new-course-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #333;
            color: #fff;
        }

        .btn-primary:hover {
            background: #555;
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        /* Quiz Screen */
        #quizScreen {
            max-width: 700px;
            margin: 0 auto;
        }

        .quiz-container {
            background: #fafafa;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 2rem;
        }

        .quiz-question {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
            color: #222;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .quiz-option {
            padding: 15px 20px;
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quiz-option:hover {
            border-color: #999;
            background: #f5f5f5;
        }

        .quiz-option.selected {
            border-color: #333;
            background: #f0f0f0;
        }

        .quiz-option.correct {
            border-color: #4CAF50;
            background: #e8f5e9;
        }

        .quiz-option.incorrect {
            border-color: #f44336;
            background: #ffebee;
        }

        .short-answer-input {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
        }

        .submit-answer-btn {
            margin-top: 1.5rem;
            padding: 12px 30px;
            background: #333;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-answer-btn:hover {
            background: #555;
        }

        .submit-answer-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .explanation-box {
            background: #fff;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 20px;
            margin-top: 1.5rem;
        }

        .explanation-title {
            font-weight: 600;
            color: #4CAF50;
            margin-bottom: 0.75rem;
        }

        .explanation-content {
            color: #555;
            line-height: 1.6;
        }

        .next-question-btn {
            margin-top: 1.5rem;
            padding: 12px 30px;
            background: #4CAF50;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .next-question-btn:hover {
            background: #45a049;
        }

        /* Error message */
        .error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <!-- Clippy Icon -->
    <img src="/static/clippy.png" alt="Clippy Assistant" class="clippy-icon" title="Your Learning Assistant">
    
    <div class="container">
        <h1>CheatSheet</h1>
        
        <!-- File Drop Screen -->
        <div id="fileDropScreen" class="screen active">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ðŸ“„</div>
                <div class="upload-text">Drop any files</div>
                <div class="upload-hint">or click to browse</div>
                <input type="file" id="fileInput" accept=".pdf">
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loadingScreen" class="screen">
            <div id="loadingStep1" class="loading-step"></div>
            <div id="loadingStep2" class="loading-step"></div>
            <div id="loadingStep3" class="loading-step"></div>
            <div id="conceptPreview" class="concept-preview" style="display: none;"></div>
            <div id="loadingStep4" class="loading-step"></div>
            <div id="loadingStep5" class="loading-step"></div>
            <div id="loadingStep6" class="loading-step"></div>
            <button id="startQuizBtn" class="start-quiz-btn">Start Quiz</button>
        </div>

        <!-- Quiz Screen -->
        <div id="quizScreen" class="screen">
            <div class="quiz-container" id="quizContainer">
                <!-- Quiz content will be dynamically inserted here -->
            </div>
        </div>

        <!-- Course Selection Modal -->
        <div id="courseModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">Select a Course</div>
                <div class="course-list" id="courseList">
                    <!-- Course items will be dynamically inserted here -->
                </div>
                <div class="new-course-section">
                    <div class="new-course-label">Or create a new course:</div>
                    <input type="text" id="newCourseInput" class="new-course-input" placeholder="Enter course name">
                </div>
                <div class="modal-buttons">
                    <button id="cancelCourseBtn" class="btn btn-secondary">Cancel</button>
                    <button id="saveCourseBtn" class="btn btn-primary">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let extractedConcepts = [];
        let selectedCourse = null;
        let currentQuiz = null;
        let currentQuizIndex = 0;
        let allQuizzes = [];

        // Elements
        const fileDropScreen = document.getElementById('fileDropScreen');
        const loadingScreen = document.getElementById('loadingScreen');
        const quizScreen = document.getElementById('quizScreen');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const courseModal = document.getElementById('courseModal');
        const courseList = document.getElementById('courseList');
        const newCourseInput = document.getElementById('newCourseInput');
        const cancelCourseBtn = document.getElementById('cancelCourseBtn');
        const saveCourseBtn = document.getElementById('saveCourseBtn');
        const startQuizBtn = document.getElementById('startQuizBtn');

        // File upload handlers
        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // Process file upload
        async function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                alert('Please upload a PDF file');
                return;
            }

            // Switch to loading screen
            showScreen('loading');
            updateLoadingStep('loadingStep1', 'Parsing the file', {loading: true});

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success && data.concepts) {
                    extractedConcepts = data.concepts;
                    
                    // Mark step 1 as completed
                    completeStep('loadingStep1');
                    await sleep(300);
                    
                    // Update loading steps
                    updateLoadingStep('loadingStep2', 'Generating the key points', {loading: true});
                    await sleep(500);
                    completeStep('loadingStep2');
                    await sleep(300);
                    
                    updateLoadingStep('loadingStep3', `Generated ${extractedConcepts.length} key points`, {completed: true});
                    
                    // Show preview
                    showConceptPreview(extractedConcepts.slice(0, 3));
                    await sleep(1000);
                    
                    // Show course selection modal
                    await showCourseSelectionModal();
                    
                } else {
                    alert(data.error || 'Failed to process file');
                    showScreen('fileDrop');
                }
            } catch (err) {
                alert('Network error: ' + err.message);
                showScreen('fileDrop');
            }
        }

        // Show concept preview
        function showConceptPreview(concepts) {
            const preview = document.getElementById('conceptPreview');
            preview.style.display = 'block';
            preview.classList.add('visible');
            preview.innerHTML = '';
            
            concepts.forEach(concept => {
                const item = document.createElement('div');
                item.className = 'concept-preview-item';
                item.textContent = `â€¢ ${concept.title}`;
                preview.appendChild(item);
            });
            
            // Add "..." to indicate more concepts
            if (extractedConcepts.length > 3) {
                const more = document.createElement('div');
                more.className = 'concept-preview-more';
                more.textContent = '...';
                preview.appendChild(more);
            }
        }

        // Course selection modal
        async function showCourseSelectionModal() {
            try {
                const response = await fetch('/api/courses');
                const data = await response.json();
                
                if (data.success) {
                    renderCourseList(data.courses);
                    courseModal.classList.add('active');
                }
            } catch (err) {
                console.error('Error fetching courses:', err);
            }
        }

        function renderCourseList(courses) {
            courseList.innerHTML = '';
            courses.forEach(course => {
                const item = document.createElement('div');
                item.className = 'course-item';
                item.textContent = course.replace(/_/g, ' ');
                item.dataset.course = course;
                item.addEventListener('click', () => selectCourse(course, item));
                courseList.appendChild(item);
            });
        }

        function selectCourse(course, element) {
            // Remove previous selection
            document.querySelectorAll('.course-item').forEach(item => {
                item.classList.remove('selected');
            });
            // Select new course
            element.classList.add('selected');
            selectedCourse = course;
            newCourseInput.value = '';
        }

        cancelCourseBtn.addEventListener('click', () => {
            courseModal.classList.remove('active');
            showScreen('fileDrop');
        });

        saveCourseBtn.addEventListener('click', async () => {
            let courseName = selectedCourse;
            
            // Check if creating new course
            if (newCourseInput.value.trim()) {
                courseName = newCourseInput.value.trim().toUpperCase().replace(/\s+/g, '_');
            }
            
            if (!courseName) {
                alert('Please select or enter a course name');
                return;
            }

            courseModal.classList.remove('active');
            
            // Continue loading steps
            updateLoadingStep('loadingStep4', 'Storing to the base', {loading: true});
            await sleep(300);
            
            // Save concepts
            try {
                const response = await fetch('/api/save_concepts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        concepts: extractedConcepts,
                        course_name: courseName,
                        is_new_course: !selectedCourse
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    completeStep('loadingStep4');
                    await sleep(300);
                    
                    updateLoadingStep('loadingStep5', 'Distributing the points', {loading: true});
                    await sleep(500);
                    completeStep('loadingStep5');
                    await sleep(300);
                    
                    updateLoadingStep('loadingStep6', 'Generating quizzes', {loading: true});
                    
                    // Generate quizzes
                    await generateQuizzes();
                    
                    completeStep('loadingStep6');
                    await sleep(300);
                    updateLoadingStep('loadingStep6', `Generated ${allQuizzes.length} quizzes`, {completed: true});
                    startQuizBtn.classList.add('visible');
                } else {
                    alert(data.error || 'Failed to save concepts');
                    showScreen('fileDrop');
                }
            } catch (err) {
                alert('Error saving concepts: ' + err.message);
                showScreen('fileDrop');
            }
        });

        // Generate quizzes using LLM
        async function generateQuizzes() {
            try {
                const response = await fetch('/api/generate_quizzes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        num_quizzes: 10
                    })
                });

                const data = await response.json();
                
                if (data.success && data.quizzes) {
                    allQuizzes = data.quizzes;
                } else {
                    // Fallback to simple quizzes
                    allQuizzes = extractedConcepts.map((concept, index) => {
                        return {
                            type: 'single_choice',
                            question: `What is ${concept.title}?`,
                            concept: concept,
                            options: [
                                concept.content,
                                'Option B (incorrect)',
                                'Option C (incorrect)',
                                'Option D (incorrect)'
                            ],
                            correct_answer: 0
                        };
                    });
                }
            } catch (err) {
                console.error('Error generating quizzes:', err);
                // Fallback
                allQuizzes = extractedConcepts.slice(0, 5).map((concept) => {
                    return {
                        type: 'single_choice',
                        question: `What is ${concept.title}?`,
                        concept: concept,
                        options: [
                            concept.content,
                            'Option B',
                            'Option C',
                            'Option D'
                        ],
                        correct_answer: 0
                    };
                });
            }
        }

        // Start quiz
        startQuizBtn.addEventListener('click', () => {
            showScreen('quiz');
            currentQuizIndex = 0;
            loadQuiz(currentQuizIndex);
        });

        // Load and display quiz
        function loadQuiz(index) {
            if (index >= allQuizzes.length) {
                // All quizzes completed
                document.getElementById('quizContainer').innerHTML = `
                    <div style="text-align: center;">
                        <h2>ðŸŽ‰ All quizzes completed!</h2>
                        <p style="margin-top: 1rem;">Great job learning these concepts.</p>
                        <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 2rem;">Upload Another File</button>
                    </div>
                `;
                return;
            }

            currentQuiz = allQuizzes[index];
            const container = document.getElementById('quizContainer');
            
            let html = `
                <div class="quiz-question">${currentQuiz.question}</div>
            `;

            if (currentQuiz.type === 'single_choice') {
                html += '<div class="quiz-options" id="quizOptions">';
                currentQuiz.options.forEach((option, i) => {
                    html += `
                        <div class="quiz-option" data-index="${i}">
                            ${option}
                        </div>
                    `;
                });
                html += '</div>';
            } else if (currentQuiz.type === 'multi_choice') {
                html += '<div class="quiz-options" id="quizOptions">';
                currentQuiz.options.forEach((option, i) => {
                    html += `
                        <div class="quiz-option" data-index="${i}">
                            ${option}
                        </div>
                    `;
                });
                html += '</div>';
                html += '<div style="margin-top: 1rem; font-size: 0.9rem; color: #666;">Select all that apply</div>';
            } else {
                html += `
                    <textarea id="shortAnswerInput" class="short-answer-input" placeholder="Type your answer here..."></textarea>
                `;
            }

            html += `
                <button id="submitAnswerBtn" class="submit-answer-btn">Submit Answer</button>
                <div id="explanationBox" style="display: none;"></div>
            `;

            container.innerHTML = html;

            // Add event listeners
            const options = document.querySelectorAll('.quiz-option');
            options.forEach(option => {
                option.addEventListener('click', () => {
                    if (currentQuiz.type === 'single_choice') {
                        options.forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                    } else {
                        option.classList.toggle('selected');
                    }
                });
            });

            document.getElementById('submitAnswerBtn').addEventListener('click', submitAnswer);
        }

        // Submit answer using LLM evaluation
        async function submitAnswer() {
            let userAnswerText;
            let userAnswerIndex;

            if (currentQuiz.type === 'single_choice') {
                const selected = document.querySelector('.quiz-option.selected');
                if (!selected) {
                    alert('Please select an answer');
                    return;
                }
                userAnswerIndex = parseInt(selected.dataset.index);
                userAnswerText = currentQuiz.options[userAnswerIndex];
            } else if (currentQuiz.type === 'multi_choice') {
                const selected = document.querySelectorAll('.quiz-option.selected');
                if (selected.length === 0) {
                    alert('Please select at least one answer');
                    return;
                }
                const indices = Array.from(selected).map(el => parseInt(el.dataset.index));
                userAnswerText = indices.map(i => currentQuiz.options[i]).join(', ');
                userAnswerIndex = indices;
            } else {
                userAnswerText = document.getElementById('shortAnswerInput').value.trim();
                if (!userAnswerText) {
                    alert('Please enter an answer');
                    return;
                }
            }

            // Disable submit button
            document.getElementById('submitAnswerBtn').disabled = true;
            document.getElementById('submitAnswerBtn').textContent = 'Evaluating...';

            // Evaluate all answer types
            let isCorrect = false;
            let needsLLMEval = false;
            
            if (currentQuiz.type === 'single_choice') {
                isCorrect = userAnswerIndex === currentQuiz.correct_answer;
            } else if (currentQuiz.type === 'multi_choice') {
                isCorrect = JSON.stringify(userAnswerIndex.sort()) === JSON.stringify(currentQuiz.correct_answer.sort());
            } else if (currentQuiz.type === 'short_answer') {
                needsLLMEval = true;  // Short answer needs LLM evaluation
            }

            // Call API to record progress for ALL question types
            try {
                const response = await fetch('/api/evaluate_answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_answer: userAnswerText,
                        concept_ref: currentQuiz.concept_ref,
                        concept: currentQuiz.concept,
                        quiz_type: currentQuiz.type,
                        is_correct: needsLLMEval ? null : isCorrect  // Pre-evaluated for choice questions
                    })
                });

                const data = await response.json();
                
                if (data.success && data.evaluation) {
                    // For short answer, use LLM evaluation result
                    if (needsLLMEval) {
                        isCorrect = data.evaluation.is_correct;
                    }
                    showFeedback(isCorrect, data.evaluation.feedback);
                    return;
                }
            } catch (err) {
                console.error('Error evaluating answer:', err);
            }

            // Fallback: Show feedback without API (shouldn't happen normally)
            showFeedback(isCorrect);
        }

        function showFeedback(isCorrect, customFeedback = null) {
            const explanationBox = document.getElementById('explanationBox');
            explanationBox.style.display = 'block';
            
            const conceptContent = Array.isArray(currentQuiz.concept.content) 
                ? currentQuiz.concept.content[0] 
                : currentQuiz.concept.content;
            
            let feedbackHTML = `
                <div class="explanation-box">
                    <div class="explanation-title">${isCorrect ? 'âœ“ Correct!' : 'âœ— Not quite right'}</div>
                    <div class="explanation-content">
            `;
            
            if (customFeedback) {
                feedbackHTML += `<p>${customFeedback}</p><br>`;
            }
            
            feedbackHTML += `
                        <strong>${currentQuiz.concept.title}:</strong><br>
                        ${conceptContent}
                    </div>
                    <button id="nextQuestionBtn" class="next-question-btn">
                        ${currentQuizIndex < allQuizzes.length - 1 ? 'Next Question' : 'Finish'}
                    </button>
                </div>
            `;
            
            explanationBox.innerHTML = feedbackHTML;

            document.getElementById('submitAnswerBtn').disabled = true;
            document.getElementById('nextQuestionBtn').addEventListener('click', () => {
                currentQuizIndex++;
                loadQuiz(currentQuizIndex);
            });
        }

        // Helper functions
        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            if (screenName === 'fileDrop') {
                fileDropScreen.classList.add('active');
            } else if (screenName === 'loading') {
                loadingScreen.classList.add('active');
            } else if (screenName === 'quiz') {
                quizScreen.classList.add('active');
            }
        }

        function updateLoadingStep(elementId, text, options = {}) {
            const element = document.getElementById(elementId);
            const isLoading = options.loading || false;
            const isCompleted = options.completed || false;
            
            // Clear previous classes
            element.classList.remove('active', 'completed');
            
            if (isLoading) {
                // Currently loading - show dots animation
                element.classList.add('active');
                element.innerHTML = text + '<span class="loading-dots"></span>';
            } else if (isCompleted) {
                // Completed - turn gray
                element.classList.add('completed');
                element.textContent = text;
            } else {
                // Default - just set text
                element.textContent = text;
            }
        }
        
        function completeStep(elementId) {
            const element = document.getElementById(elementId);
            element.classList.remove('active');
            element.classList.add('completed');
            // Remove loading dots if present
            const dots = element.querySelector('.loading-dots');
            if (dots) {
                dots.remove();
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>
